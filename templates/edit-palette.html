{% extends "base_logged_in.html" %}

{% block title %}Palettes{% endblock %}

{% block content %}
<div class="edit-palette-content">
    <h1 style="text-align:center;">{{ palette['name'] }}</h1>
    <div class="palette-edit-color" data-palette-name="{{ palette['name'] }}">
        <h4>Add Color</h4>
        <form method="POST" action="/add_color">
            <div class="color_name">
                <label for="color_name">Name: </label>
                <input type="text" class="color_name" id="color_name" name="color_name" 
                placeholder="e.g. pale-pink" onkeyup="check_input()">
            </div>
            <div class="color-form-group">
                <label for="hex">Hex:</label>
                <div style="display:flex; align-items:center;">
                    <span style="user-select:none;">#</span>
                    <input type="text" class="color-picker-text" id="hex" name="hex" 
                        placeholder="FFFFFF" maxlength="6" 
                        style="width:70px; text-transform:uppercase;" onkeyup="check_input()">
                </div>
                
                <label for="color_picker"></label>
                <input type="color" id="color_picker" name="new_color" value="#a6a6a6">
            </div>
        </form>
        <button type="button" id="add_color_button" class="add-color-button" disabled>Add Color</button>
    </div>
    <div class="palette-box" data-palette-name="{{ palette['name'] }}">
        <div class="palette-colors">
            {% for color in colors %}
            <div class="color-box" style="--box-color: {{ color['hex_value'] }};" data-color-id="{{ color['color_id'] }}">
                <button class="delete_color_button">&times;</button>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
<script>
    let colorPicker = document.getElementById("color_picker");
    let hexInput = document.getElementById("hex");

    hexInput.value = colorPicker.value.slice(1);

    hexInput.addEventListener('input', () => {
        hexInput.value = hexInput.value.replace(/[^0-9A-Fa-f]/g, '').toUpperCase();

        if (hexInput.value.length > 6) {
            hexInput.value = hexInput.value.slice(0,6);
        }

        colorPicker.value = '#' + (hexInput.value.padEnd(6, '0'))

        check_input()
    })
</script>
<script>
    function check_input() {
        const color_name = document.getElementById("color_name").value.trim();
        const hex = document.getElementById("hex").value.trim();
        const button = document.getElementById("add_color_button");
        button.disabled = !(color_name && hex);
    }
</script>
<script>

    function hexToRgb(hex) {
        // Remove # if present
        hex = hex.replace(/^#/, '');

        // Parse the 6-digit hex
        const bigint = parseInt(hex, 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;

        return { r, g, b };
    }
    colorPicker.addEventListener('input', () => {
        hexInput.value = colorPicker.value.slice(1);
        check_input();
    });

    document.getElementById("add_color_button").addEventListener("click", async () => {
        const colorName = document.getElementById("color_name").value.trim();
        const colorValue = document.getElementById("color_picker").value;
        const rgb = hexToRgb(colorValue);
        const paletteName = "{{ palette['name'] }}";  // pass the palette name from Flask

        // Send POST request with JSON
        const response = await fetch("/add_color_ajax", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                palette: paletteName,
                name: colorName,
                hex: colorValue,
                r: rgb.r,
                g: rgb.g,
                b: rgb.b
            })
        });

        if (response.ok) {
            const data = await response.json();
            // Update the palette colors dynamically
            const container = document.querySelector(".palette-colors");
            container.innerHTML = "";  // clear existing
            // Rebuild color boxes with delete buttons
            data.colors.forEach(c => {
                const div = document.createElement("div");
                div.classList.add("color-box");
                div.style.setProperty("--box-color", c.hex_value);
                div.dataset.colorId = c.color_id;

                // Add delete button
                const delBtn = document.createElement("button");
                delBtn.classList.add("delete_color_button");
                delBtn.innerHTML = "&times;";
                div.appendChild(delBtn);

                container.appendChild(div);
            });

            // Reset inputs
            document.getElementById("color_name").value = "";
            document.getElementById("hex").value = "";
            document.getElementById("add_color_button").disabled = true;
            document.getElementById("hex").focus();
            check_input()
        } else {
            alert("Failed to add color.");
        }
    });
</script>
<script>
const paletteContainer = document.querySelector(".palette-colors");

paletteContainer.addEventListener("click", async (event) => {
    if (!event.target.classList.contains("delete_color_button")) return;

    const colorDiv = event.target.closest(".color-box");
    const colorId = colorDiv.dataset.colorId;
    const paletteName = "{{ palette['name'] }}";

    Swal.fire({
        title: "Delete this color?",
        text: "This action cannot be undone.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "Yes, delete it",
        cancelButtonText: "Cancel"
    }).then(async (result) => {
        if (!result.isConfirmed) return;

        try {
            const response = await fetch("/delete_color_ajax", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ palette: paletteName, color_id: colorId })
            });

            if (response.ok) {
                const data = await response.json();
                paletteContainer.innerHTML = "";

                data.colors.forEach(c => {
                    const div = document.createElement("div");
                    div.classList.add("color-box");
                    div.style.setProperty("--box-color", c.hex_value);
                    div.dataset.colorId = c.color_id;

                    const delBtn = document.createElement("button");
                    delBtn.classList.add("delete_color_button");
                    delBtn.innerHTML = "&times;";
                    div.appendChild(delBtn);

                    paletteContainer.appendChild(div);
                });
            } else {
                const err = await response.json();
                Swal.fire("Error", err.error || "Failed to delete color.", "error");
            }
        } catch (err) {
            Swal.fire("Error", err.message || "Failed to delete color.", "error");
        }
    });
});
</script>


{% endblock %}